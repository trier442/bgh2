<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배곧고2 국어 기말대비 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <script>
        function setScreenHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setScreenHeight();
        window.addEventListener('resize', setScreenHeight);
    </script>
    <style>
        body {
            font-family: 'Jua', sans-serif;
            touch-action: manipulation;
        }
        #game-container {
            height: calc(var(--vh, 1vh) * 100);
        }
        @media (min-width: 640px) {
            #game-container {
                height: 90vh;
                max-height: 800px;
            }
        }
        .road-line {
            position: absolute; width: 6px; height: 100%; top: 0;
            background-image: linear-gradient(to bottom, white 50%, transparent 50%);
            background-size: 100% 70px; animation: road-lines 2.5s linear infinite;
        }
        @keyframes road-lines { from { background-position: 0 0; } to { background-position: 0 70px; } }
        @keyframes fall { from { transform: translateY(-100px); } to { transform: translateY(100vh); } }
        .falling { animation: fall 10s linear; }
        #car { transition: left 0.2s ease-out; }
        .modal { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; transform: scale(0.9); pointer-events: none; }
        #player-name-input { border: 2px solid #6366f1; transition: border-color 0.3s; }
        #player-name-input:focus { outline: none; border-color: #a5b4fc; }
        #leaderboard ol { list-style-type: decimal; padding-left: 2rem; }
        #leaderboard li { display: flex; justify-content: space-between; }
        .quiz-select-btn {
            transition: all 0.2s ease-in-out;
        }
        .quiz-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen overflow-hidden">

    <div id="game-container" class="w-full max-w-md bg-gray-600 rounded-lg shadow-2xl flex flex-col relative overflow-hidden border-4 border-gray-700">
        
        <div class="absolute top-1.5 left-1/2 -translate-x-1/2 text-xs text-gray-400 z-30">배곧국풀국어학원</div>

        <div class="bg-gray-900 text-white p-4 shadow-lg z-20 flex flex-col space-y-2">
            <div class="flex justify-between items-center text-base md:text-lg font-bold pt-4">
                <div id="player-info" class="hidden">Player: <span id="player-name-display"></span></div>
                <div id="score-display" class="hidden">점수: <span id="score">0</span></div>
            </div>
            <div id="question" class="text-center text-lg md:text-xl min-h-[5rem] flex items-center justify-center px-2 border-t border-gray-700 pt-2"></div>
        </div>

        <div id="game-screen" class="flex-1 relative">
            <div class="road-line" style="left: 33.33%; transform: translateX(-50%);"></div>
            <div class="road-line" style="left: 66.66%; transform: translateX(-50%);"></div>
            <div id="car" class="w-12 h-16 absolute bottom-8 left-1/2 -translate-x-1/2 text-5xl z-10">🚓</div>
            <div id="answers-container" class="absolute w-full h-24 flex justify-around" style="top: 0;"></div>
        </div>

        <div class="bg-gray-900 p-2 flex justify-center space-x-2 sm:hidden z-20">
            <button id="move-left-btn" class="w-1/3 bg-blue-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-blue-700">◀</button>
            <button id="move-forward-btn" class="w-1/3 bg-green-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-green-700">▲</button>
            <button id="move-right-btn" class="w-1/3 bg-blue-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-blue-700">▶</button>
        </div>

        <div id="start-screen" class="modal absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-30 px-4 overflow-y-auto py-4">
            <h1 id="start-title" class="text-3xl md:text-4xl font-bold text-white mb-4 text-center">배곧고2 국어 기말대비 퀴즈</h1>
            
            <div id="name-input-container" class="w-full max-w-sm mb-4 flex-shrink-0">
                <label for="player-name-input" class="block text-white text-center mb-2">플레이어 이름을 입력하세요</label>
                <input type="text" id="player-name-input" class="w-full px-4 py-2 rounded-lg bg-gray-200 text-gray-800 text-center font-bold" placeholder="이름" maxlength="10">
            </div>

            <div id="quiz-selection-container" class="w-full max-w-sm flex-shrink-0">
                 <p id="start-desc" class="text-yellow-300 text-lg mb-4 text-center">플레이할 작품을 선택하세요!</p>
                 <div id="quiz-options" class="grid grid-cols-2 gap-3">
                 </div>
            </div>
            
            <div id="leaderboard" class="mt-6 w-full max-w-sm text-white bg-gray-800 bg-opacity-50 p-4 rounded-lg hidden flex-shrink-0">
                <h3 id="leaderboard-title" class="text-2xl text-yellow-300 font-bold text-center mb-2">🏆 명예의 전당 🏆</h3>
                <ol id="leaderboard-list" class="text-lg"></ol>
            </div>

            <div id="restart-container" class="mt-6 hidden flex-shrink-0">
                <button id="restart-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-full text-2xl shadow-lg transform hover:scale-105 transition-transform">
                    작품 선택으로
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        const elements = {
            car: document.getElementById('car'),
            gameScreen: document.getElementById('game-screen'),
            question: document.getElementById('question'),
            score: document.getElementById('score'),
            answersContainer: document.getElementById('answers-container'),
            startScreen: document.getElementById('start-screen'),
            startTitle: document.getElementById('start-title'),
            startDesc: document.getElementById('start-desc'),
            moveLeftBtn: document.getElementById('move-left-btn'),
            moveRightBtn: document.getElementById('move-right-btn'),
            moveForwardBtn: document.getElementById('move-forward-btn'),
            playerNameInput: document.getElementById('player-name-input'),
            playerNameDisplay: document.getElementById('player-name-display'),
            playerInfo: document.getElementById('player-info'),
            scoreDisplay: document.getElementById('score-display'),
            nameInputContainer: document.getElementById('name-input-container'),
            quizSelectionContainer: document.getElementById('quiz-selection-container'),
            quizOptions: document.getElementById('quiz-options'),
            leaderboard: document.getElementById('leaderboard'),
            leaderboardTitle: document.getElementById('leaderboard-title'),
            leaderboardList: document.getElementById('leaderboard-list'),
            restartContainer: document.getElementById('restart-container'),
            restartButton: document.getElementById('restart-button')
        };
        
        let db;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyDcagfE320vd1DuT6uZ8mHhVy2yB74C1q0",
                authDomain: "grammar-294b6.firebaseapp.com",
                projectId: "grammar-294b6",
                storageBucket: "grammar-294b6.appspot.com",
                messagingSenderId: "865611264169",
                appId: "1:865611264169:web:84b9e6d784c3b41bd139b8"
            };
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
        } catch (e) { console.error("Firebase initialization failed:", e); }

        let audioCtx;
        const setupAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };
        const playSound = (type) => {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            } else {
                osc.type = 'square'; osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            }
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        };

        const quizzes = {
            '고공가': [
                { question: "이 작품에서 '고공(머슴)'이 비유하는 대상은?", answers: ["백성", "왕", "관리(신하)"], correct: 2 },
                { question: "'화강도'가 비유하는 것은 무엇인가?", answers: ["왜적(임진왜란)", "흉년", "부패한 관리"], correct: 0 },
                { question: "작품의 배경이 되는 시기는 언제인가?", answers: ["조선 건국 초기", "임진왜란 직후", "병자호란 직후"], correct: 1 },
                { question: "머슴들이 다투는 주된 이유는 무엇인가?", answers: ["농사 방법", "서로의 게으름", "밥그릇(녹봉) 크기"], correct: 2 },
                { question: "'여드레가리 텃밭'이 상징하는 것은?", answers: ["한양", "조선 팔도", "왕의 영토"], correct: 1 },
                { question: "이 작품의 갈래로 가장 적절한 것은?", answers: ["향가", "시조", "가사"], correct: 2 },
                { question: "화자가 머슴들에게 새 마음을 먹으라고 촉구하는 이유는?", answers: ["가세가 기울었기 때문", "새로운 농법 도입", "주인이 바뀌었기 때문"], correct: 0 },
                { question: "화자가 머슴들에게 당부하는 내용이 아닌 것은?", answers: ["서로 협력할 것", "농사에 힘쓸 것", "더 좋은 옷을 요구할 것"], correct: 2 },
                { question: "이 작품에서 화자는 어떤 어조로 머슴들을 대하는가?", answers: ["칭찬하는 어조", "명령하고 꾸짖는 어조", "방관하는 어조"], correct: 1 },
                { question: "화자가 '사려 깊은 새 머슴'을 기다리는 이유는?", answers: ["현재 머슴을 해고하기 위해", "집안일을 맡기고 시름을 잊기 위해", "더 많은 수확을 위해"], correct: 1 },
                { question: "이 노래는 나라의 일을 무엇에 비유하였는가?", answers: ["전쟁", "잔치", "농사일"], correct: 2 },
                { question: "조선을 건국한 '이성계'에 비유된 시어는?", answers: ["화강도", "한어버이", "고공"], correct: 1 },
                { question: "요즘 머슴들이 '마음을 다투는 듯, 우두머리를 시기하는 듯' 하는 모습은 무엇을 풍자하는가?", answers: ["당파 싸움", "신분 갈등", "농사 다툼"], correct: 0 },
                { question: "'화살을 전혀 아니 메고 옷밥만 다투느냐'에서 '화살'이 의미하는 바는?", answers: ["사냥 도구", "농기구", "국방 준비"], correct: 2 },
                { question: "작품의 마지막에 화자가 애달파하며 다 꼬았다고 한 것은?", answers: ["짚신 한 켤레", "새끼 한 사리", "가마니 한 장"], correct: 1 },
                { question: "화자는 머슴들이 일에 힘쓰지 않는 이유가 무엇 때문이라고 하는가?", answers: ["생각(사려 분별)이 없어서", "녹봉이 적어서", "주인이 무서워서"], correct: 0 },
                { question: "머슴들이 서로 협력해야 함을 나타내는 구절은?", answers: ["한 솥에 밥 먹으며", "누고는 장기 잡고 누고는 쇼을 모니", "너희 재주를 헤아려"], correct: 1 },
                { question: "이 작품과 관련 있는 한자성어가 아닌 것은?", answers: ["우국지정", "경세제민", "태평성대"], correct: 2 },
                { question: "이 작품의 성격으로 거리가 먼 것은?", answers: ["풍자적", "우의적", "연정적"], correct: 2 },
                { question: "허전의 '고공가'에 대한 답가 형식의 작품은?", answers: ["이원익의 '고공답주인가'", "정철의 '관동별곡'", "박인로의 '누항사'"], correct: 0 }
            ],
            '안민가': [
                { question: "이 노래의 갈래는 무엇인가?", answers: ["향가", "고려가요", "시조"], correct: 0 },
                { question: "이 노래는 몇 구체 형식의 향가인가?", answers: ["4구체", "8구체", "10구체"], correct: 2 },
                { question: "화자는 군(임금), 신(신하), 민(백성)을 어떤 관계에 비유했는가?", answers: ["스승과 제자", "가족(부모자식)", "주인과 종"], correct: 1 },
                { question: "이 노래에서 '신하'는 가족 관계의 누구에 비유되었는가?", answers: ["아버지", "자식", "어머니"], correct: 2 },
                { question: "'백성이 사랑받음을 알 것'이라고 한 전제 조건은?", answers: ["백성이 세금을 잘 내면", "임금과 신하가 부모처럼 행동하면", "나라가 부강해지면"], correct: 1 },
                { question: "백성을 '어리석은 아이'라고 표현한 이유는?", answers: ["정치에 무지해서", "보살핌이 필요한 존재여서", "신분이 낮아서"], correct: 1 },
                { question: "백성을 다스리는 방법으로 제시된 것은 무엇인가?", answers: ["엄격한 법 집행", "강력한 군사력", "먹여 다스리는 것"], correct: 2 },
                { question: "나라가 태평해지기 위한 조건으로 마지막에 제시된 것은?", answers: ["강력한 왕권 확립", "모두 자기 본분을 다하는 것", "활발한 정복 활동"], correct: 1 },
                { question: "이 노래의 사상적 배경으로 가장 적절한 것은?", answers: ["불교", "도교", "유교"], correct: 2 },
                { question: "이 노래를 지은 작가는 누구인가?", answers: ["원효", "충담사", "월명사"], correct: 1 },
                { question: "이 노래가 실려 있는 문헌은?", answers: ["삼국사기", "고려사", "삼국유사"], correct: 2 },
                { question: "낙구(9~10행) 첫머리의 감탄사는 무엇인가?", answers: ["어즈버", "아으", "아소"], correct: 1 },
                { question: "이 노래의 창작을 명한 왕은 누구인가?", answers: ["신문왕", "진흥왕", "경덕왕"], correct: 2 },
                { question: "백성이 '이 땅을 버리고 어디로 갈 것인가'라고 말하지 않게 하는 것이 무엇이라 했는가?", answers: ["부역 면제", "치국(나라 다스림)", "종교의 자유"], correct: 1 },
                { question: "'임금답게 신하답게 백성답게 한다'는 것은 공자의 어떤 사상과 관련이 깊은가?", answers: ["인(仁) 사상", "예(禮) 사상", "정명(正名) 사상"], correct: 2 },
                { question: "화자는 어떤 어조로 임금에게 노래를 바치고 있는가?", answers: ["아첨하는 어조", "권계(훈계)하는 어조", "체념적인 어조"], correct: 1 },
                { question: "당시 백성들이 '이 땅을 버리고' 다른 곳으로 가는 일이 많았음을 알 수 있다. (O/X)", answers: ["O", "X"], correct: 0 },
                { question: "이 노래는 개인의 정서보다 무엇을 더 중시하는가?", answers: ["자연의 아름다움", "사회적 이념", "사랑의 감정"], correct: 1 },
                { question: "'구믈거리며 살아가는 백성'이라는 표현은 백성에 대한 어떤 태도를 보여주는가?", answers: ["연민과 애정", "경멸과 무시", "두려움과 경계"], correct: 0 },
                { question: "이 노래의 주제는 '치국안민'의 도이다. '안민'의 뜻은?", answers: ["백성을 편안하게 함", "백성을 가르침", "백성을 동원함"], correct: 0 }
            ],
            '김춘수, 꽃': [
                { question: "이 시의 화자가 '그'의 이름을 불러주기 전, '그'는 무엇에 지나지 않았는가?", answers: ["하나의 몸짓", "하나의 빛깔", "하나의 향기"], correct: 0 },
                { question: "화자가 '그'의 이름을 불러주었을 때, '그'는 무엇이 되었는가?", answers: ["나비", "새", "꽃"], correct: 2 },
                { question: "'이름을 부르는 행위'의 의미로 가장 적절한 것은?", answers: ["존재를 소유하는 행위", "존재의 본질을 파악하고 의미를 부여하는 행위", "존재를 처음 발견하는 행위"], correct: 1 },
                { question: "화자가 '나의 이 빛깔과 향기'에 알맞은 이름을 불러달라고 한 이유는?", answers: ["자신의 본질을 인정받고 싶어서", "자신을 뽐내고 싶어서", "아름다워지고 싶어서"], correct: 0 },
                { question: "이 시에서 '꽃'이 상징하는 것은?", answers: ["아름다운 자연", "구체적인 식물", "의미 있는 존재"], correct: 2 },
                { question: "화자의 소망은 3연에서 '나'로부터 4연의 어떤 존재로 확대되는가?", answers: ["너", "그", "우리들"], correct: 2 },
                { question: "4연에서 '너는 나에게 나는 너에게 잊혀지지 않는 하나의 눈짓이 되고 싶다'가 의미하는 것은?", answers: ["서로를 감시하는 관계", "서로에게 의미있는 존재가 되는 관계", "서로 스쳐지나가는 관계"], correct: 1 },
                { question: "이 시의 성격으로 가장 적절한 것은?", answers: ["현실 비판적", "관념적, 존재론적", "자연 친화적"], correct: 1 },
                { question: "이 시에서 시상이 전개되면서 인식의 범위가 어떻게 변하는가?", answers: ["점점 축소된다", "변화가 없다", "점층적으로 확대된다"], correct: 2 },
                { question: "이 시의 제재는 '꽃'이지만, 궁극적으로 무엇에 대해 노래하고 있는가?", answers: ["사랑의 기쁨", "존재의 본질", "자연의 신비"], correct: 1 },
                { question: "이 시의 화자가 소망하는 관계는?", answers: ["수직적 관계", "일방적인 관계", "상호 주체적인 관계"], correct: 2 },
                { question: "이 시의 어조로 가장 적절한 것은?", answers: ["냉소적인 어조", "단호한 어조", "간절한 소망의 어조"], correct: 2 },
                { question: "이 시에서 '몸짓', '꽃', '눈짓'으로 시어가 변하며 의미가 어떻게 되는가?", answers: ["심화, 확대된다", "약화, 축소된다", "구체화된다"], correct: 0 },
                { question: "이름을 불러주기 전의 '그'와 같은 무의미한 상태를 나타내는 시어는?", answers: ["꽃", "몸짓", "눈짓"], correct: 1 },
                { question: "이 시의 작가는 누구인가?", answers: ["김소월", "김춘수", "윤동주"], correct: 1 },
                { question: "3연에서 화자는 '누가' 자신의 이름을 불러주기를 소망한다. (O/X)", answers: ["O", "X"], correct: 0 },
                { question: "이 시는 구체적 체험을 바탕으로 존재의 의미를 추구하고 있다. (O/X)", answers: ["X", "O"], correct: 1 },
                { question: "4연의 '무엇'이 되고 싶다는 것은 어떤 존재가 되고 싶다는 뜻인가?", answers: ["아름다운 존재", "강력한 존재", "의미 있는 존재"], correct: 2 },
                { question: "이 시의 주제와 가장 관련 깊은 철학적 질문은?", answers: ["어떻게 살 것인가?", "존재란 무엇인가?", "무엇이 선인가?"], correct: 1 },
                { question: "이 시에서 진정한 관계 맺음의 첫 단계는 무엇인가?", answers: ["희생하기", "이름 불러주기", "선물 주기"], correct: 1 }
            ],
            '꽃밭의 독백': [
                { question: "이 시는 어떤 설화를 모티프로 창작되었는가?", answers: ["주몽 설화", "박혁거세 설화", "사소 설화"], correct: 2 },
                { question: "화자가 '입맛을 잃었다'고 한 대상이 아닌 것은?", answers: ["노래와 말", "산돼지와 산새", "구름과 바다"], correct: 2 },
                { question: "화자가 '입맛을 잃었다'고 말한 이유는?", answers: ["인간 세계의 유한성을 깨달아서", "맛있는 음식이 없어서", "몸이 아파서"], correct: 0 },
                { question: "화자가 가장 좋다고 말하며 지향하는 대상은?", answers: ["노래", "말", "꽃"], correct: 2 },
                { question: "화자는 '아침마다 개벽하는 꽃'을 통해 무엇을 느끼는가?", answers: ["덧없는 아름다움", "소멸과 생성의 영원함", "자연의 냉혹함"], correct: 1 },
                { question: "화자가 자신을 '헤엄도 모르는 아이'에 비유한 이유는?", answers: ["영원의 세계에 합일되지 못하는 한계", "자신의 순수함을 강조하기 위해", "물에 대한 두려움 때문에"], correct: 0 },
                { question: "화자가 '기대 섰을 뿐'이라고 말한 '닫힌 문'은 무엇을 상징하는가?", answers: ["소통의 단절", "안전한 보호막", "유한과 무한의 경계"], correct: 2 },
                { question: "화자가 '문 열어라'라고 반복해서 외치는 이유는?", answers: ["영원한 세계에 대한 강한 열망", "갇혀 있는 답답함의 토로", "누군가에게 도움을 요청"], correct: 0 },
                { question: "화자가 영원의 세계로 가는 길이 될지라도 감수하겠다고 한 것은?", answers: ["외로움과 고독", "벼락과 해일", "가난과 고통"], correct: 1 },
                { question: "이 시의 화자가 추구하는 세계의 성격은?", answers: ["현실적, 세속적 세계", "초월적, 영원한 세계", "자연 친화적 세계"], correct: 1 },
                { question: "'노래'와 '말'이 각각 멈추는 한계의 공간은 어디인가?", answers: ["구름, 바닷가", "산, 강", "하늘, 땅"], correct: 0 },
                { question: "이 시에 드러난 화자의 주된 정서는?", answers: ["체념과 절망", "구도적 열망", "자연에 대한 경외"], correct: 1 },
                { question: "이 시의 부제인 '사소 단장'의 '사소'는 누구의 어머니인가?", answers: ["주몽", "박혁거세", "단군"], correct: 1 },
                { question: "이 시의 어조로 가장 적절한 것은?", answers: ["독백적, 주술적", "객관적, 분석적", "냉소적, 비판적"], correct: 0 },
                { question: "이 시에서 '꽃'과 대조되는 의미를 지닌 시어를 찾는다면?", answers: ["벼락", "아이", "산돼지"], correct: 2 },
                { question: "화자는 '꽃'의 세계에 완전히 도달했는가?", answers: ["도달했다", "도달하지 못했다", "알 수 없다"], correct: 1 },
                { question: "'문 열어라 꽃아'라는 구절에서 '꽃'은 어떤 대상인가?", answers: ["대화의 상대", "청원과 기도의 대상", "관찰의 대상"], correct: 1 },
                { question: "이 시의 작가는 누구인가?", answers: ["김소월", "한용운", "서정주"], correct: 2 },
                { question: "이 시에서 '개벽'의 의미로 가장 적절한 것은?", answers: ["세상이 처음 열림", "꽃이 시듦", "새롭게 태어남"], correct: 2 },
                { question: "화자는 '벼락과 해일'과 같은 시련을 어떻게 받아들이고 있는가?", answers: ["두려워하며 피하려 함", "극복하려는 의지를 보임", "체념하고 받아들임"], correct: 1 }
            ],
            '선상탄': [
                { question: "이 작품의 갈래는 무엇인가?", answers: ["시조", "향가", "가사"], correct: 2 },
                { question: "화자의 직책은 무엇인가?", answers: ["육군 장수", "수군 통주사", "의병장"], correct: 1 },
                { question: "화자가 배 위에서 눈을 부릅뜨고 바라보는 곳은?", answers: ["한양", "대마도", "명나라"], correct: 1 },
                { question: "이 작품의 시간적 배경이 되는 전쟁은?", answers: ["병자호란", "임진왜란", "정유재란"], correct: 1 },
                { question: "화자는 전쟁의 원인을 제공했다며 누구를 원망하는가?", answers: ["선조 임금", "헌원씨와 진시황", "이순신 장군"], correct: 1 },
                { question: "진시황이 동남동녀를 보낸 이유는 무엇을 구하기 위함이었나?", answers: ["보물", "특산물", "불사약"], correct: 2 },
                { question: "화자는 배의 유용성을 언급하며 누구의 풍류를 예로 들었는가?", answers: ["이백", "두보", "장한"], correct: 2 },
                { question: "과거 풍류를 즐기던 배와 현재 화자가 탄 배의 가장 큰 차이점은?", answers: ["배의 크기", "실려 있는 물건(술상 vs 무기)", "배의 속도"], correct: 1 },
                { question: "화자가 때때로 머리를 들어 바라보는 '북신(북극성)'이 상징하는 것은?", answers: ["고향", "가족", "임금"], correct: 2 },
                { question: "화자의 우국단심이 드러나는 구절의 의미로 옳은 것은?", answers: ["나라의 문물이 중국보다 못하다", "늙고 병들어 공을 세우기 어렵다", "나라 걱정하는 마음은 잊지 않았다"], correct: 2 },
                { question: "화자가 자신의 처지를 비관하면서도 왜적을 물리칠 수 있다고 자신하는 근거로 든 인물이 아닌 것은?", answers: ["제갈공명", "손빈", "관우"], correct: 2 },
                { question: "화자가 왜적을 '쥐나 개 같은 도적'에 비유한 이유는?", answers: ["그들의 비겁함을 강조하기 위해", "그들의 용맹함을 인정하기 위해", "그들의 신출귀몰함을 표현하기 위해"], correct: 0 },
                { question: "왜적을 물리친 후 화자가 꿈꾸는 태평성대의 모습이 아닌 것은?", answers: ["전쟁 배를 고깃배로 바꿈", "더 큰 배를 만들어 무역을 함", "가을 달, 봄바람에 편히 누워 쉼"], correct: 1 },
                { question: "'해불양파(海不揚波)'는 어떤 상태를 비유하는 말인가?", answers: ["풍랑이 심한 바다", "매우 부유한 나라", "매우 평화로운 세상"], correct: 2 },
                { question: "이 작품의 주된 정서로 가장 적절한 것은?", answers: ["자연에 대한 예찬", "사랑의 기쁨", "우국충정과 평화에 대한 염원"], correct: 2 },
                { question: "화자는 늙고 병들었지만 기개는 젊을 때 못지않다고 말한다. 이를 나타내는 한자성어는?", answers: ["노익장", "백전노장", "용두사미"], correct: 0 },
                { question: "전쟁의 기운을 상징적으로 표현한 시어는?", answers: ["창파(푸른 바다)", "황운(누런 구름)", "북신(북극성)"], correct: 1 },
                { question: "이 작품에서 '배'는 어떤 이중적 의미를 지니는가?", answers: ["풍류와 전쟁", "희망과 절망", "만남과 이별"], correct: 0 },
                { question: "화자는 왜적에게 빨리 항복하라고 권하며 '항복한 자는 죽이지 않는다'는 원칙을 언급한다. (O/X)", answers: ["O", "X"], correct: 0 },
                { question: "이 작품의 작가는 누구인가?", answers: ["정철", "윤선도", "박인로"], correct: 2 }
            ],
            '최척전': [
                { question: "이 소설의 주된 시대적 배경은?", answers: ["고려 말", "임진왜란, 정유재란", "병자호란"], correct: 1 },
                { question: "최척과 옥영이 처음 만난 후 사랑을 확인하는 매개체는?", answers: ["노래", "편지", "선물"], correct: 1 },
                { question: "최척이 의병으로 떠난 후 옥영의 어머니가 옥영을 누구와 혼인시키려 했는가?", answers: ["양생", "송우", "돈우"], correct: 0 },
                { question: "전쟁으로 헤어진 최척을 중국으로 데려가 도와준 명나라 장수는?", answers: ["송우", "두홍", "여유문"], correct: 2 },
                { question: "왜군에게 포로로 잡힌 옥영을 도와준 일본인 장사꾼은?", answers: ["소서행장", "돈우", "여유문"], correct: 1 },
                { question: "옥영이 자살을 포기하고 삶의 희망을 갖게 된 계기는?", answers: ["최척의 편지를 받고", "돈우의 설득으로", "장륙불의 꿈을 꾸고"], correct: 2 },
                { question: "조선, 일본, 중국을 떠돌던 최척과 옥영이 극적으로 재회한 장소는 어디인가?", answers: ["일본 나고야", "중국 요흥", "안남(베트남)"], correct: 2 },
                { question: "두 사람이 안남에서 재회하게 되는 직접적인 계기는?", answers: ["퉁소 소리와 시", "서로의 얼굴을 알아봄", "조력자의 도움"], correct: 0 },
                { question: "최척이 명나라 군사로 참전했다가 포로가 되어 만난 인물은?", answers: ["아버지 최숙", "첫째 아들 몽석", "장인 심씨"], correct: 1 },
                { question: "이 소설의 결말은 어떠한가?", answers: ["비극적 결말", "열린 결말", "행복한 결말"], correct: 2 },
                { question: "이 작품의 공간적 배경이 아닌 곳은?", answers: ["조선", "안남(베트남)", "인도"], correct: 2 },
                { question: "기존 고전소설과 다른 '최척전'의 특징으로 적절하지 않은 것은?", answers: ["진취적인 여성상 제시", "사실적인 전쟁 묘사", "권선징악적 결말"], correct: 2 },
                { question: "옥영의 성격으로 가장 적절한 것은?", answers: ["소극적, 순종적", "적극적, 진취적", "냉소적, 비판적"], correct: 1 },
                { question: "최척전의 다른 이름으로, '기이한 만남의 기록'이라는 뜻을 가진 것은?", answers: ["임진록", "기우록", "금오신화"], correct: 1 },
                { question: "최척과 옥영의 이별과 재회 과정에서 가장 두드러지는 서사 장치는?", answers: ["필연성", "우연성", "풍자"], correct: 1 },
                { question: "최척의 둘째 아들 몽선은 누구와 혼인하는가?", answers: ["조선인", "일본인", "중국인"], correct: 2 },
                { question: "최척의 부친과 장모가 손자 몽석을 우연히 다시 만난 장소는?", answers: ["연곡사", "남원성", "금석교"], correct: 0 },
                { question: "전쟁으로 인한 민중의 고통을 사실적으로 그렸다는 점에서 이 작품의 성격은?", answers: ["전기적", "사실적", "몽상적"], correct: 1 },
                { question: "작품 속에서 '꿈'의 기능으로 적절한 것은?", answers: ["현실 도피의 수단", "사건의 복선 역할", "주인공의 능력 과시"], correct: 1 },
                { question: "이 작품의 작가는 누구인가?", answers: ["김만중", "조위한", "허균"], correct: 1 }
            ],
            '일야구도하기': [
                { question: "이 글의 갈래로 가장 적절한 것은?", answers: ["소설", "기행 수필", "희곡"], correct: 1 },
                { question: "글의 제목 '일야구도하기'의 뜻은?", answers: ["하룻밤에 아홉 번 절하기", "하룻밤에 아홉 번 강 건너기", "하룻밤에 아홉 가지 도리 깨닫기"], correct: 1 },
                { question: "글쓴이가 요란한 강물 소리를 무엇에 비유한 것이 아닌 것은?", answers: ["전쟁터의 함성", "개구리 떼 울음소리", "아이들 웃음소리"], correct: 2 },
                { question: "글쓴이에 따르면 강물 소리가 다르게 들리는 이유는?", answers: ["강물의 유속 때문에", "강의 지형 때문에", "듣는 이의 마음가짐에 따라"], correct: 2 },
                { question: "낮에 강을 건너던 사람들이 하늘을 쳐다본 진짜 이유는?", answers: ["하늘에 기도를 하려고", "물을 보면 어지러워서", "별을 보려고"], correct: 1 },
                { question: "낮에 강을 건널 때 강물 소리를 듣지 못한 이유는?", answers: ["강물이 조용해서", "눈으로 보는 위험에 집중해서", "귀가 좋지 않아서"], correct: 1 },
                { question: "밤에 강을 건널 때 두려움을 느낀 이유는?", answers: ["눈이 아닌 귀에 의존했기 때문", "물귀신이 나올 것 같아서", "길을 잃을까 봐"], correct: 0 },
                { question: "글쓴이가 밤에 강을 건너며 깨달은 '도(道)'의 핵심은?", answers: ["자연을 정복해야 한다", "마음을 다스려 외물에 흔들리지 않아야 한다", "친구와 협력해야 한다"], correct: 1 },
                { question: "글쓴이가 마음의 평온을 되찾기 위해 강물을 무엇처럼 여긴 것이 아닌 것은?", answers: ["대지", "내 옷", "내 원수"], correct: 2 },
                { question: "글쓴이가 자신의 주장을 뒷받침하기 위해 인용한 인물은?", answers: ["공자", "맹자", "우임금"], correct: 2 },
                { question: "이 글은 박지원의 어느 기행문에 실려 있는가?", answers: ["열하일기", "서유견문", "표해록"], correct: 0 },
                { question: "글쓴이가 경계해야 한다고 말한 '외물(外物)'은 무엇인가?", answers: ["소리와 빛깔 등 감각의 대상", "마음 속 번뇌", "타인의 평가"], correct: 0 },
                { question: "글쓴이가 '도를 깨달았다'고 했을 때, 그 깨달음의 내용은?", answers: ["감각을 믿어야 한다", "마음을 다스리면 감각에 휘둘리지 않는다", "밤에는 강을 건너지 말아야 한다"], correct: 1 },
                { question: "죽고 사는 문제에 초연했던 '우임금'의 고사를 통해 강조하려는 바는?", answers: ["용의 강력함", "마음가짐의 중요성", "배 만드는 기술"], correct: 1 },
                { question: "글쓴이는 세상살이가 강 건너는 것보다 어떻다고 했는가?", answers: ["훨씬 더 안전하다", "훨씬 더 위험하다", "비슷하다"], correct: 1 },
                { question: "이 글에 드러난 글쓴이의 태도로 가장 적절한 것은?", answers: ["사색적, 분석적", "감상적, 낭만적", "비판적, 냉소적"], correct: 0 },
                { question: "'보고 듣는 것이 자세하면 할수록 병폐가 되는' 사람은 어떤 사람인가?", "answers": ["마음을 다스린 사람", "귀와 눈만 믿는 사람", "지식이 많은 사람"], "correct": 1 },
                { question: "글쓴이가 '마침내 귓병이 날 지경'이라고 한 이유는?", "answers": ["계곡물 소리가 너무 커서", "실제로 귀에 병이 생겨서", "물소리가 지겨워서"], "correct": 0 },
                { question: "글쓴이가 자신의 깨달음을 검증하겠다고 한 장소는?", "answers": ["요동 벌판", "백하", "산중의 대문 앞 계곡"], "correct": 2 },
                { question: "글쓴이가 경고하고자 하는 대상은 누구인가?", "answers": ["자연을 두려워하는 사람", "자신의 감각만 믿는 사람", "여행을 싫어하는 사람"], "correct": 1 }
            ],
            '장마': [
                { question: "이 소설의 주된 시대적 배경은?", answers: ["일제강점기", "6.25 전쟁", "4.19 혁명"], correct: 1 },
                { question: "갈등의 중심에 있는 두 인물은 누구인가?", answers: ["나와 아버지", "할머니와 외할머니", "삼촌과 외삼촌"], correct: 1 },
                { question: "두 할머니가 갈등하게 되는 직접적인 계기는?", answers: ["'나'의 거짓말", "외삼촌의 전사 소식과 외할머니의 저주", "점쟁이의 예언"], correct: 1 },
                { question: "할머니와 외할머니의 갈등의 근본적인 원인은?", answers: ["성격 차이", "이념의 대립", "재산 문제"], correct: 1 },
                { question: "이 소설의 서술자는 누구이며, 어떤 시점을 취하고 있는가?", answers: ["어른 '나', 3인칭 관찰자", "어린 '나', 1인칭 관찰자", "할머니, 1인칭 주인공"], correct: 1 },
                { question: "삼촌이 돌아온다는 점쟁이의 예언을 들은 할머니의 태도는?", answers: ["불신하며 무시함", "반신반의하며 기다림", "신앙처럼 굳게 믿음"], correct: 2 },
                { question: "작품의 제목이기도 한 '장마'가 상징하는 것은?", answers: ["풍요와 다산", "전쟁의 비극과 갈등 상황", "오랜 기다림"], correct: 1 },
                { question: "약속한 날에 삼촌 대신 나타나 갈등 해결의 계기가 되는 존재는?", answers: ["구렁이", "비둘기", "제비"], correct: 0 },
                { question: "구렁이를 대하는 두 할머니의 공통적인 태도는?", answers: ["두려워하며 쫓아내려 함", "삼촌의 현신이라 여기고 정성껏 대함", "무시하고 신경쓰지 않음"], correct: 1 },
                { question: "갈등 해소의 과정에서 결정적인 역할을 하는 것은?", answers: ["합리적 토론", "법의 심판", "무속 신앙과 모성애"], correct: 2 },
                { question: "외할머니가 구렁이를 돌려보내기 위해 태운 것은?", answers: ["삼촌의 옷", "부적", "할머니의 머리카락"], correct: 2 },
                { question: "두 할머니가 화해하는 장면에서 나눈 첫 마디는?", answers: ["미안하오", "고맙소", "용서하시오"], correct: 1 },
                { question: "이 작품의 결말에서 '나'와 할머니는 어떻게 되는가?", answers: ["끝까지 화해하지 못함", "서로를 용서하며 화해함", "나는 할머니를 용서하지만 할머니는 그렇지 않음"], correct: 1 },
                { question: "소설의 마지막 문장 '정말 지루한 장마였다'가 주는 효과는?", answers: ["사건의 비극성 강조", "새로운 갈등 암시", "깊은 여운과 상징성 부각"], correct: 2 },
                { question: "이 작품에서 '사투리' 사용의 효과가 아닌 것은?", answers: ["현장감과 사실성 부여", "토속적 분위기 형성", "주제의 보편성 획득"], correct: 2 },
                { question: "작품 속 '나'가 정신적으로 성장하는 모습을 보인다는 점에서 이 소설은 어떤 소설의 성격을 지니는가?", answers: ["역사 소설", "성장 소설", "사회 소설"], correct: 1 },
                { question: "상처 입은 구렁이는 무엇을 상징하는가?", answers: ["죽은 삼촌의 원한", "분단된 우리 민족의 모습", "자연의 파괴"], correct: 1 },
                { question: "어린아이인 '나'를 서술자로 설정하여 얻는 효과는?", answers: ["이념 대립을 객관적으로 전달", "사건의 희극성 강조", "주제의 직접적 전달"], correct: 0 },
                { question: "이 작품이 궁극적으로 말하고자 하는 바는?", answers: ["이념의 절대성", "전쟁의 필연성", "민족 동질성을 통한 화합"], correct: 2 },
                { question: "작품 속에서 '장마'가 그치자 어떤 일이 일어나는가?", answers: ["두 할머니의 갈등이 해소됨", "삼촌이 돌아옴", "외삼촌이 살아옴"], correct: 0 }
            ],
            '한거십팔곡': [
                { question: "이 작품의 갈래는 무엇인가?", answers: ["가사", "단시조", "연시조"], correct: 2 },
                { question: "화자가 평생 원한다고 한 두 가지 유교적 덕목은?", answers: ["인의(仁義)", "충효(忠孝)", "예지(禮智)"], correct: 1 },
                { question: "화자는 '이 두 일'을 하지 않으면 무엇과 다르지 않다고 했는가?", answers: ["초목", "금수(짐승)", "소인배"], correct: 1 },
                { question: "화자가 벼슬길에 나아가 이루려는 '공명'과 대조되는 공간은?", answers: ["한양", "임천(자연)", "궁궐"], correct: 1 },
                { question: "화자가 갈림길(기로)에 서서 갈등하는 이유는?", answers: ["'성주'를 섬기는 일과 '소락'(자연 속 즐거움) 사이에서", "두 여인 사이에서", "과거 시험과 학문 수양 사이에서"], correct: 0 },
                { question: "벼슬살이의 어려움을 무엇에 비유했는가?", answers: ["험한 산길", "풍랑 속의 배", "위기(危機)"], correct: 2 },
                { question: "화자가 자연 속에서 즐기는 삶을 나타내는 한자성어는?", answers: ["치군택민", "조월경운", "부귀공명"], correct: 1 },
                { question: "화자는 '지혜로운 군자'가 출사와 은거를 모두 즐긴다고 말한다. (O/X)", answers: ["O", "X"], correct: 0 },
                { question: "화자는 자연 속에서 누구를 벗으로 삼고 있는가?", answers: ["백구(갈매기)", "원학(원숭이와 학)", "어부와 목동"], correct: 1 },
                { question: "'한 대의 거문고와 만권의 책'이 있는 공간의 분위기는?", answers: ["소쇄(깨끗하고 시원)하다", "시끌벅적하다", "우울하다"], correct: 0 },
                { question: "화자는 세상의 부귀공명을 무엇처럼 여긴다고 했는가?", answers: ["뜬구름", "뜬소문", "뜬눈"], correct: 0 },
                { question: "화자는 강물을 보며 무엇을 생각하는가?", answers: ["고향에 대한 그리움", "인생의 덧없음", "정치 현실에 대한 분노"], correct: 1 },
                { question: "십 년 전의 '진세일념(세속에 대한 마음)'이 어떻게 되었다고 했는가?", answers: ["더욱 강해졌다", "얼음 녹듯 한다", "후회만 남았다"], correct: 1 },
                { question: "화자는 숨어 지내든 벼슬길에 나아가든 '도'는 다르지 않다고 말한다. (O/X)", answers: ["O", "X"], correct: 0 },
                { question: "이 작품의 주제로 가장 적절한 것은?", answers: ["벼슬길의 어려움 토로", "자연 예찬과 학문 수양의 즐거움", "임에 대한 그리움과 충절"], correct: 1 },
                { question: "화자가 '계교(서로 견주어 봄)'하다가 '공명'이 늦었다고 말한다. (O/X)", answers: ["O", "X"], correct: 0 },
                { question: "자연을 상징하는 시어가 아닌 것은?", answers: ["임천", "강호", "세사"], correct: 2 },
                { question: "초승달을 무엇에 비유했는가?", answers: ["은쟁반", "은갈고리(낚시)", "쪽배"], correct: 1 },
                { question: "화자는 '가난하게 사는 것(빈천거)'을 부귀보다 낫다고 생각한다. (O/X)", answers: ["O", "X"], correct: 0 },
                { question: "이 작품의 작가는 누구인가?", answers: ["윤선도", "권호문", "송순"], correct: 1 }
            ],
            '구두 한 켤레의 시': [
                { question: "이 시의 중심 소재이며, 화자가 고향을 떠올리는 매개체는?", answers: ["강물 소리", "낡은 구두", "겨울 보리"], correct: 1 },
                { question: "화자가 고향을 방문한 주된 목적은 무엇이었나?", answers: ["여행", "차례(제사)", "친구를 만나기 위해"], correct: 1 },
                { question: "구두 밑바닥에 '묻어 있다'고 표현된 것은 무엇인가?", answers: ["고향의 흙", "고향의 강물 소리", "고향의 꽃잎"], correct: 1 },
                { question: "'강물 소리가 묻어 있다'는 표현에 사용된 주된 표현 기법은?", answers: ["의인법", "역설법", "공감각적 심상"], correct: 2 },
                { question: "화자가 고향의 강물 소리를 직접 듣지 못한 이유는?", answers: ["강이 너무 멀어서", "귀가 얼어서", "너무 시끄러워서"], correct: 1 },
                { question: "화자와 대조적으로 고향의 강물 소리를 '듣고 온' 존재는?", answers: ["나 자신", "구두", "바람"], correct: 1 },
                { question: "터진 구두 틈으로 나온 발가락을 무엇에 비유했는가?", answers: ["꿈틀대는 벌레", "부끄러운 촉수", "허기진 입"], correct: 1 },
                { question: "화자가 '부끄러움'을 느끼는 근본적인 이유는?", answers: ["구두가 낡아서", "자신은 고향과 교감하지 못해서", "고향이 가난해서"], correct: 1 },
                { question: "시의 마지막에 '출렁출렁'이 '덜그럭덜그럭'으로 바뀌는데, '덜그럭덜그럭'은 무엇의 소리인가?", answers: ["강물 소리", "기차 소리", "구두 소리"], correct: 2 },
                { question: "이 시에서 그려지는 고향의 전체적인 분위기는?", answers: ["밝고 희망참", "활기차고 정겨움", "어둡고 쓸쓸함"], correct: 2 },
                { question: "이 시의 화자는 고향에 대한 어떤 태도를 보이는가?", answers: ["무관심한 태도", "성찰적 태도", "비판적 태도"], correct: 1 },
                { question: "시에서 '황혼'은 시간적 배경이 아니라 무엇의 상태를 비유한 것인가?", answers: ["화자의 마음", "낡은 구두", "고향의 풍경"], correct: 1 },
                { question: "이 시에서 화자와 '구두'는 어떤 관계에 있는가?", answers: ["동일시 관계", "대조적 관계", "인과 관계"], correct: 1 },
                { question: "화자는 고향에서 '꽃잎 하나 바람 한 점'과 같은 따뜻한 정을 듬뿍 받고 돌아왔다. (O/X)", answers: ["O", "X"], correct: 1 },
                { question: "화자가 고향에 머문 시간은 어떠했다고 묘사되는가?", answers: ["아주 길었다", "건성으로 보냈다", "매우 즐거웠다"], correct: 1 },
                { question: "이 시의 계절적 배경을 알 수 있는 시어가 아닌 것은?", answers: ["겨울 보리", "살얼음", "유채 꽃잎"], correct: 2 },
                { question: "'구두 혼자 어떻게 듣고 왔을까'에 사용된 표현법은?", answers: ["직유법", "은유법", "의인법"], correct: 2 },
                { question: "화자는 고향의 현실을 제대로 보지 못했다고 말한다. (O/X)", answers: ["O", "X"], correct: 0 },
                { question: "현재형 어미를 사용하여 얻는 효과로 가장 적절한 것은?", answers: ["과거에 대한 그리움 강조", "미래에 대한 불확실성 표현", "생동감과 현장감 부여"], correct: 2 },
                { question: "이 시의 작가는 누구인가?", answers: ["김춘수", "정호승", "곽재구"], correct: 2 }
            ]
        };
        
        let carPosition, score, currentQuestionIndex, gameLoopId, playerName, currentQuizData, currentQuizKey;
        let isGameActive = false;
        let questionInProgress = false;

        const initGame = () => {
            carPosition = 1; score = 0; currentQuestionIndex = 0;
            isGameActive = true; questionInProgress = false;
            elements.playerInfo.classList.remove('hidden');
            elements.scoreDisplay.classList.remove('hidden');
            elements.playerNameDisplay.textContent = playerName;
            document.querySelectorAll('.road-line').forEach(line => line.style.animationPlayState = 'running');
            updateScore();
            shuffleQuiz();
            loadQuestion();
            updateCarPosition();
            elements.quizSelectionContainer.classList.add('hidden');
            elements.startScreen.classList.add('hidden');
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoopId = requestAnimationFrame(gameLoop);
        };

        const gameLoop = () => {
            if (!isGameActive) return;
            const carRect = elements.car.getBoundingClientRect();
            const answersRect = elements.answersContainer.getBoundingClientRect();
            if (questionInProgress && answersRect.bottom > carRect.top && answersRect.top < carRect.bottom) {
                handleCollision();
            }
            if (questionInProgress && answersRect.top > window.innerHeight) {
                handleCollision(true);
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        };
        
        const handleCollision = (missed = false) => {
            if (!questionInProgress) return;
            questionInProgress = false;
            elements.answersContainer.style.animationPlayState = 'paused';
            const currentQuiz = currentQuizData[currentQuestionIndex];
            const correctGate = elements.answersContainer.children[currentQuiz.correct];
            if (missed) {
                if (correctGate) correctGate.classList.replace('bg-blue-500', 'bg-yellow-500');
                playSound('incorrect');
            } else {
                if (carPosition === currentQuiz.correct) {
                    score += 5; updateScore();
                    correctGate.classList.replace('bg-blue-500', 'bg-green-500');
                    playSound('correct');
                } else {
                    const wrongGate = elements.answersContainer.children[carPosition];
                    if (wrongGate) wrongGate.classList.replace('bg-blue-500', 'bg-red-600');
                    if (correctGate) correctGate.classList.replace('bg-blue-500', 'bg-green-500');
                    playSound('incorrect');
                }
            }
            currentQuestionIndex++;
            setTimeout(loadQuestion, 1000);
        };

        const checkAnswerNow = () => { if (questionInProgress) handleCollision(false); };

        const shuffleQuiz = () => {
            for (let i = currentQuizData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentQuizData[i], currentQuizData[j]] = [currentQuizData[j], currentQuizData[i]];
            }
        };

        const loadQuestion = () => {
            if (currentQuestionIndex >= currentQuizData.length) {
                endGame();
                return;
            }
            questionInProgress = true;
            const currentQuiz = currentQuizData[currentQuestionIndex];
            elements.question.textContent = `Q${currentQuestionIndex + 1}. ${currentQuiz.question}`;
            elements.answersContainer.innerHTML = '';
            currentQuiz.answers.forEach((answer) => {
                const answerEl = document.createElement('div');
                answerEl.className = 'w-1/3 h-full flex items-center justify-center text-white text-base md:text-lg font-bold p-2 text-center bg-blue-500 bg-opacity-75 border-2 border-blue-300 rounded-lg';
                answerEl.textContent = answer;
                elements.answersContainer.appendChild(answerEl);
            });
            elements.answersContainer.classList.remove('falling');
            void elements.answersContainer.offsetWidth;
            elements.answersContainer.style.animationPlayState = 'running';
            elements.answersContainer.classList.add('falling');
        };

        const endGame = async () => {
            isGameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.querySelectorAll('.road-line').forEach(line => line.style.animationPlayState = 'paused');
            await saveScore(playerName, score, currentQuizKey);
            await displayLeaderboard(currentQuizKey);
            elements.question.textContent = `퀴즈 완료! 최종 점수: ${score}점`;
            elements.answersContainer.innerHTML = '';
            elements.playerInfo.classList.add('hidden');
            elements.scoreDisplay.classList.add('hidden');
            elements.startTitle.textContent = "게임 클리어!";
            elements.startDesc.innerHTML = `최종 점수: <span class="text-2xl text-white font-bold">${score}</span>점`;
            elements.nameInputContainer.classList.add('hidden');
            elements.quizSelectionContainer.classList.add('hidden');
            elements.leaderboard.classList.remove('hidden');
            elements.restartContainer.classList.remove('hidden'); 
            elements.startScreen.classList.remove('hidden');
        };

        const updateCarPosition = () => {
            const laneWidth = elements.gameScreen.offsetWidth / 3;
            elements.car.style.left = `${(carPosition * laneWidth) + (laneWidth / 2)}px`;
        };

        const moveCar = (direction) => {
            if (!isGameActive) return;
            if (direction === 'left' && carPosition > 0) carPosition--;
            else if (direction === 'right' && carPosition < 2) carPosition++;
            updateCarPosition();
        };

        const updateScore = () => { elements.score.textContent = score; };

        const saveScore = async (name, score, quizKey) => {
            if (!db) return;
            const collectionName = `baegot-quiz-scores-${quizKey}`;
            try { await addDoc(collection(db, collectionName), { name, score, createdAt: serverTimestamp() }); } 
            catch (e) { console.error("Error adding document: ", e); }
        };

        const displayLeaderboard = async (quizKey) => {
            if (!db) return;
            const collectionName = `baegot-quiz-scores-${quizKey}`;
            const quizTitle = Object.keys(quizzes).find(key => key.replace(/[^a-zA-Z0-9가-힣]/g, '') === quizKey);
            elements.leaderboardTitle.textContent = `🏆 ${quizTitle} 명예의 전당 🏆`;
            elements.leaderboardList.innerHTML = '<li>불러오는 중...</li>';
            try {
                const q = query(collection(db, collectionName), orderBy("score", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                elements.leaderboardList.innerHTML = '';
                if (querySnapshot.empty) {
                    elements.leaderboardList.innerHTML = '<li>아직 랭킹이 없습니다.</li>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${data.name}</span><span>${data.score}점</span>`;
                    elements.leaderboardList.appendChild(li);
                });
            } catch (e) {
                console.error("Error getting documents: ", e);
                elements.leaderboardList.innerHTML = '<li>랭킹을 불러오지 못했습니다.</li>';
            }
        };

        const populateQuizOptions = () => {
            elements.quizOptions.innerHTML = ''; 
            Object.keys(quizzes).forEach(quizName => {
                const btn = document.createElement('button');
                btn.textContent = quizName.replace(', 꽃', ',꽃').replace(' - 7월',''); 
                btn.className = "quiz-select-btn w-full bg-indigo-500 text-white font-bold py-3 px-2 rounded-lg text-sm md:text-base active:bg-indigo-700";
                btn.onclick = () => {
                    setupAudio();
                    playerName = elements.playerNameInput.value.trim();
                    if (!playerName) {
                        elements.playerNameInput.placeholder = "이름을 꼭 입력해주세요!";
                        elements.playerNameInput.classList.add('border-red-500');
                        setTimeout(() => {
                            elements.playerNameInput.classList.remove('border-red-500');
                            elements.playerNameInput.placeholder = "이름";
                        }, 1500);
                        return;
                    }
                    currentQuizKey = quizName.replace(/[^a-zA-Z0-9가-힣]/g, '');
                    currentQuizData = quizzes[quizName];
                    initGame();
                };
                elements.quizOptions.appendChild(btn);
            });
        };

        const resetToSelection = () => {
            elements.startTitle.textContent = "배곧고2 국어 기말대비 퀴즈";
            elements.startDesc.textContent = "플레이할 작품을 선택하세요!";
            elements.restartContainer.classList.add('hidden');
            elements.leaderboard.classList.add('hidden');
            elements.nameInputContainer.classList.remove('hidden');
            elements.quizSelectionContainer.classList.remove('hidden');
        };
        
        populateQuizOptions();

        document.addEventListener('keydown', (e) => {
            if (elements.startScreen.classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') moveCar('left');
                else if (e.key === 'ArrowRight') moveCar('right');
                else if (e.key === 'ArrowUp' || e.key === ' ') { e.preventDefault(); checkAnswerNow(); }
            }
        });

        elements.moveLeftBtn.addEventListener('click', () => moveCar('left'));
        elements.moveRightBtn.addEventListener('click', () => moveCar('right'));
        elements.moveForwardBtn.addEventListener('click', checkAnswerNow);
        elements.restartButton.addEventListener('click', resetToSelection);
        window.addEventListener('resize', () => { if (isGameActive) updateCarPosition(); });
    </script>
</body>
</html>
